# Internet Identity Integration Example

This guide shows how to integrate Internet Identity into a dapp front-end and make use of the user identity in the backend. It builds on the "greet" dapp that is generated by running `dfx new`. If you are unfamiliar with `dfx new` and the generated application, please have a look at [this tutorial](https://internetcomputer.org/docs/current/developer-docs/quickstart/local-quickstart) first.

The code contained in this folder shows the finished solution you should arrive at after following the step-by-step instructions.

## Goal

This tutorial will explain all the steps required to integrate the default starter template (generated using `dfx new`) with Internet Identity. When finished, the application will do the following:
* offer a login with Internet Identity button
* greet you with the principal provided by Internet Identity instead of entering a name

## Steps

### Prerequisites

Required software components:
* node.js v16+
* dfx

You should have a starter project ready generated by `dfx new <name>` with the following file structure:

```
├── README.md
├── dfx.json
├── package.json
├── src
│   ├── <name>_backend
│   │   └── main.mo
│   └── <name>_frontend
│       ├── assets
│       │   ├── favicon.ico
│       │   ├── logo2.svg
│       │   ├── main.css
│       │   └── sample-asset.txt
│       └── src
│           ├── index.html
│           └── index.js
└── webpack.config.js
```

> Note: the example provided here used the name "greet".

### 1: Add Internet Identity to the local project
 
Add this block to the canister section in `dfx.json`:

```json
"internet_identity": {
  "type": "custom",
  "candid": "https://github.com/dfinity/internet-identity/releases/latest/download/internet_identity.did",
  "wasm": "https://github.com/dfinity/internet-identity/releases/latest/download/internet_identity_dev.wasm.gz",
  "remote": {
    "id": {
      "ic": "rdmx6-jaaaa-aaaaa-aaadq-cai"
    }
  },
  "frontend": {}
}
```

This adds a prebuilt Internet Identity canister to your project. The `remote` property makes sure, that this canister is only deployed locally (as it already exists on mainnet). The `frontend` property tells `dfx` that this canister does have a front-end (so it prints the front-end URL after deployment, see the next step). The URLs point to the latest dev build release of Internet Identity. The [dev build](https://github.com/dfinity/internet-identity#flavors) has some extra features that make Internet Identity easier to use in a development setting (such as a predictable captcha, no requirement for WebAuthn, etc.).

### 2: Deploy Internet Identity locally

Run `dfx deploy` to deploy all canisters including Internet Identity to the local replica.
It should print the Internet Identity URL to the console:
```
...
Deployed canisters.
URLs:
  Frontend canister via browser
    greet_frontend: http://127.0.0.1:4943/?canisterId=ryjl3-tyaaa-aaaaa-aaaba-cai
    internet_identity: http://127.0.0.1:4943/?canisterId=r7inp-6aaaa-aaaaa-aaabq-cai
  Backend canister via Candid interface:
...
```

> Note: depending on the state of your local replica, canister ids might be different.

Open the `internet_identity` link in the browser. You should be able to create anchors and register devices.

### 3: Make the Internet Identity URL available in the build process

We want the greet application to integrate with Internet Identity differently depending on whether we deploy locally or on mainnet:
* locally the application should use the Internet Identity URL `http://127.0.0.1:4943/?canisterId=<II_CANISTER_ID>`
* on mainnet it should use `https://identity.ic0.app`

To do so we make an environment variable `II_URL` available using `webpack`.

1. Move the `const network` variable outside the function `initCanisterEnv` to make it accessible in the whole file
2. Define the Internet Identity URL:
   ```
   const internetIdentityUrl = network === "local" ? `http://localhost:4943/?canisterId=${canisterEnvVariables["INTERNET_IDENTITY_CANISTER_ID"]}` : `https://identity.ic0.app`
   ```
3. Add the URL to the environment variables:
   ```js
   ...
   new webpack.EnvironmentPlugin({
      NODE_ENV: "development",
      II_URL: internetIdentityUrl,
      ...canisterEnvVariables,
    }),
   ...
   ```
The `webpack.conf.js` should now look similar to [this](https://github.com/dfinity/examples/blob/master/motoko/internet_identity_integration/webpack.config.js).

### 4: Add the auth-client library to the front-end

The [auth-client](https://www.npmjs.com/package/@dfinity/auth-client) is a library provided by DFINITY to make integration with Internet Identity easy.
Run `npm install @dfinity/auth-client @dfinity/identity --save-dev`

### 5: Add a login button to the front-end

Modify the `index.html` to show a login button and remove the input field for the name. The greeting will be addressed to the calling identity in the future, so this field is no longer needed.

The result could look like this:
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>greet</title>
    <base href="/" />
    <link rel="icon" href="favicon.ico" />
    <link type="text/css" rel="stylesheet" href="main.css" />
  </head>
  <body>
    <main>
      <img src="logo2.svg" alt="DFINITY logo" />
      <br />
      <br />
      <form>
        <button id="login">Login!</button>
      </form>
      <br />
      <form>
        <button id="greet">Click Me!</button>
      </form>
      <section id="greeting"></section>
    </main>
  </body>
</html>
```

### 6: Make the login button interact with II

In order for the login button to work, we need to give it behavior. Add the following two lines at the top of `index.js`:
```js
import {AuthClient} from "@dfinity/auth-client"
import {HttpAgent} from "@dfinity/agent";
```

First, we define the predefined back-end actor as a global variable so that we can interact with it with both buttons:
```js
let actor = greet_backend;
````

Then further below implement the button handler to do the login flow with Internet Identity:

```js
const loginButton = document.getElementById("login");
loginButton.onclick = async (e) => {
    e.preventDefault();

    let authClient = await AuthClient.create();

    await new Promise((resolve) => {
        authClient.login({
            identityProvider: process.env.II_URL,
            onSuccess: resolve,
        });
    });

    // At this point we're authenticated, and we can get the identity from the auth client:
    const identity = authClient.getIdentity();
    // Using the identity obtained from the auth client, we can create an agent to interact with the IC.
    const agent = new HttpAgent({identity});
    // Using the interface description of our webapp, we create an actor that we use to call the service methods. We override the global actor, such that the other button handler will automatically use the new actor with the Internet Identity provided delegation.
    actor = createActor(process.env.GREET_BACKEND_CANISTER_ID, {
        agent,
    });

    return false;
};
```

### 7: Modify the back-end

We want our application to greet the `caller` principal. In order to do so, the back-end Motoko code needs to be changed to:
* no longer take a `name` parameter
* use the `message.caller` for the greeting

```
import Principal "mo:base/Principal";

actor {
  public query (message) func greet() : async Text {
    return "Hello, " # Principal.toText(message.caller) # "!";
  };
};
```

Run `dfx deploy` again. This will also regenerate the bindings in `src/declarations`.

### 8: Use the Internet Identity session to call the back-end

Finally, we need to change the code of the button handler of the "Click Me!" button to use the delegation provided by Internet Identity.

```js
const greetButton = document.getElementById("greet");
greetButton.onclick = async (e) => {
    e.preventDefault();

    greetButton.setAttribute("disabled", true);

    // Interact with backend actor, calling the greet method
    const greeting = await actor.greet();

    greetButton.removeAttribute("disabled");

    document.getElementById("greeting").innerText = greeting;

    return false;
};
```

This was the final code change required. The code should now look similar to what is provided in this example.

### 9: Deploy and test the application

Run `dfx deploy` again to deploy the updated application.

You should be able to observe the following behaviour:
* If you press the "Click me!" button without logging in first, you should be greeted by the anonymous principal (2vxsx-fae).
* If you log in with Internet Identity, you should get a different principal.
  * Using the same anchor multiple times should always yield the same principal.
  * Using a different anchor will result in different principals.
